// Source: app\main.py
from flask import Flask
from flask_cors import CORS
from routes import register_routes
import config

app = Flask(__name__)
CORS(app)

register_routes(app)

if __name__ == '__main__':
    app.run(debug=True)
// Source: app\routes.py
from flask import request, jsonify
from PIL import Image
import pytesseract
import json
from langdetect import detect
from services.name_extraction import extract_name_from_text_using_list
from services.grading import grade_exam

def register_routes(app):

    @app.route('/extract-name', methods=['POST'])
    def extract_name():
        uploaded_file = request.files.get('file')
        student_names_list = request.form.get('student_names_list')
        language = request.form.get('language', 'eng+heb')

        if not uploaded_file or not student_names_list:
            return jsonify({"error": "Missing file or student_names_list"}), 400

        try:
            student_names_list = json.loads(student_names_list)
            student_image = Image.open(uploaded_file)
            student_exam_text = pytesseract.image_to_string(student_image, lang=language)

            firstName, lastName, confidence = extract_name_from_text_using_list(student_exam_text, student_names_list)

            return jsonify({
                "firstName": firstName,
                "lastName": lastName,
                "confidence": confidence,
            })

        except Exception as e:
            print(e)
            return jsonify({"error": str(e)}), 500


    @app.route('/detect-language', methods=['POST'])
    def detect_language():
        try:
            if 'file' not in request.files:
                return jsonify({"error": "Missing file"}), 400

            file = request.files.get('file')
            image = Image.open(file)

            text = pytesseract.image_to_string(image, lang='eng+heb')

            if not text.strip():
                return jsonify({"language": "unknown"})

            lang_code = detect(text)

            if lang_code == 'he':
                language = 'heb'
            elif lang_code == 'en':
                language = 'eng'
            else:
                language = 'unknown'

            return jsonify({
                "language": language
            })

        except Exception as e:
            return jsonify({"language": "unknown", "error": str(e)}), 500


    @app.route('/grade', methods=['POST'])
    def grade():
        if 'student_exam' not in request.files or 'teacher_exam' not in request.files:
            return jsonify({"error": "Missing student_exam or teacher_exam file"}), 400

        try:
            student_exam_file = request.files['student_exam']
            teacher_exam_file = request.files['teacher_exam']
            language = request.form.get('lang', 'eng+heb')

            student_image = Image.open(student_exam_file.stream)
            teacher_image = Image.open(teacher_exam_file.stream)

            student_exam_text = pytesseract.image_to_string(student_image, lang=language)
            teacher_exam_text = pytesseract.image_to_string(teacher_image, lang=language)

            grade_result = grade_exam(student_exam_text, teacher_exam_text)
            result_json = json.loads(grade_result)
            grade = result_json.get("grade")
            evaluation = result_json.get("evaluation")

            return jsonify({
                "grade": grade,
                "evaluation": evaluation
            })

        except Exception as e:
            print(e)
            return jsonify({"error": str(e)}), 500
// Source: app\services\__init__.py
// Source: app\services\grading.py
from openai import OpenAI
import json

client = OpenAI()
my_model = "gpt-4o-mini"

def grade_exam(student_exam, teacher_exam):
    print(student_exam)
    print(teacher_exam)
    prompt = f"""
    ×ª×œ××™×“×” ×¢× ×ª×” ×¢×œ ×”××‘×—×Ÿ ×”×‘×:
    {student_exam}

    ×”×ª×©×•×‘×•×ª ×”× ×›×•× ×•×ª ×”×Ÿ:
    {teacher_exam}

    ×× × ×ª×Ÿ ×¦×™×•×Ÿ ××“×•×™×§ ×‘××—×•×–×™× ×œ×ª×©×•×‘×•×ª ×©×œ ×”×ª×œ××™×“×” ×•×”×¡×‘×¨ ××ª ×”×¦×™×•×Ÿ. ×× ×”×ª×©×•×‘×•×ª ×©×œ ×”×ª×œ××™×“×” × ×›×•× ×•×ª, ×’× ×× ×”×Ÿ ×©×•× ×•×ª ××”×ª×©×•×‘×•×ª ×©×œ ×”××•×¨×”, ×× × ×¦×™×™×Ÿ ×–××ª ×›"× ×›×•×Ÿ",  ×•×”×¡×‘×¨ ×©×”×Ÿ ×›×•×œ×œ×•×ª ××ª ×”××™×“×¢ ×”×‘×¡×™×¡×™ ×”× ×“×¨×©. 
    ×× ×”×ª×©×•×‘×•×ª × ×›×•× ×•×ª ××š ×—×¡×¨×•×ª ×¤×¨×˜×™× ×–× ×™×—×™× , ×™×© ×œ×¦×™×™×Ÿ ×–××ª, ××š ×œ× ×œ×”×•×¨×™×“ ×¦×™×•× ×™×  .
    ×× ×™×© ×‘×”×Ÿ ×—×œ×§ ×©×’×•×™ ×œ×—×œ×•×˜×™×Ÿ ××– ×™×© ×œ×”×•×¨×™×“ 
     ×”×—×–×¨ ××ª ×”×ª×©×•×‘×•×ª ×‘×¤×•×¨××˜ JSON ×›×š:
     ×œ×œ× ×”×•×¡×¤×ª ×”××™×œ×” JSON 
     ×”×ª×©×•×‘×” ×¦×¨×™×›×” ×œ×”×ª×—×™×œ ×™×©×¨ ×‘ 
    {{
        "grade": "×¦×™×•×Ÿ ×‘××—×•×–×™×",
        "evaluation": "×”×¢×¨×›×” ×‘××™×œ×™×"
    }}
    """

    response = client.chat.completions.create(
        model=my_model,
        messages=[
            {
                "role": "system",
                "content": "You are a helpful assistant."
            },
            {
                "role": "user",
                "content": prompt
            }
        ])

    return response.choices[0].message.content
// Source: app\services\name_extraction.py
from openai import OpenAI
import json

client = OpenAI()
my_model = "gpt-4o-mini"

def extract_name_from_text_using_list(student_text, student_list):
    names_str = "\n".join(student_list)
    prompt = f"""
    ×œ×”×œ×Ÿ ×¨×©×™××ª ×©××•×ª ×©×œ ×ª×œ××™×“×•×ª:
    {names_str}

    ×–×”×• ×˜×§×¡×˜ ×©× ×œ×§×— ×××‘×—×Ÿ ×©×œ ××—×ª ××”×Ÿ:
    {student_text}

    ×”×•×¨××•×ª ×—×©×•×‘×•×ª:
    - ×¢×œ×™×š ×œ×‘×—×•×¨ ××š ×•×¨×§ ×©× ××ª×•×š ×”×¨×©×™××” â€“ ××¡×•×¨ ×œ×”××¦×™× ×©××•×ª ×©×œ× ×§×™×™××™× ×‘×”.
    - ×’× ×× ××•×¤×™×¢ ×‘×˜×§×¡×˜ ×©× ×“×•××” ××š ×©×’×•×™ ×‘×›×ª×™×‘, ×¢×œ×™×š ×œ×”×ª××™× ××•×ª×• ×œ×©× ×”×›×™ ×“×•××” ××”×¨×©×™××” **×•×œ×”×—×–×™×¨ ××ª ×”× ×™×¡×•×— ×”××“×•×™×§ ×©××•×¤×™×¢ ×‘×¨×©×™××”**.
    - ×× ××™×Ÿ ×”×ª×××” ×¡×‘×™×¨×” â€“ ×”×—×–×¨ "Null".

    ğŸ“Œ ×”×¤×œ×˜ ×—×™×™×‘ ×œ×”×™×•×ª ×‘×§×•×‘×¥ JSON ×‘×œ×‘×“, ×œ×œ× ×”×¡×‘×¨×™×, ×•×œ×œ× ×˜×§×¡×˜ × ×•×¡×£, ×•×‘×¤×•×¨××˜ ×”×‘×:
    ×”×¤×œ×˜ ×—×™×™×‘ ×œ×”×ª×—×™×œ ×‘×¡×•×’×¨×™×™× ×”××¡×•×œ×¡×œ×•×ª ×©×œ ×” JSON
    {{
    "firstName": "×©× ×¤×¨×˜×™ ××ª×•×š ×”×¨×©×™××” ××• Null",
    "lastName": "×©× ××©×¤×—×” ××ª×•×š ×”×¨×©×™××” ××• Null",
    "confidence": "××—×•×–×™× ×-0 ×¢×“ 100"
    }}
    """

    response = client.chat.completions.create(
        model=my_model,
        messages=[
            {"role": "system", "content": "××ª×” ××–×”×” ×©××•×ª ×©×œ ×ª×œ××™×“×•×ª ××ª×•×š ×˜×§×¡×˜×™× ×©×œ ××‘×—× ×™×."},
            {"role": "user", "content": prompt}
        ]
    )

    try:
        result = json.loads(response.choices[0].message.content)
        firstName = result.get("firstName")
        lastName = result.get("lastName")
        confidence = int(result.get("confidence", 0))
        if firstName != "Null" and lastName != "Null":
            return firstName, lastName, confidence
    except Exception as e:
        print("AI name extract error:", e)

    return "Null", "Null", 0
// Source: app\utils\__init__.py
// Source: app\utils\ocr.py
import pytesseract
from PIL import Image

def image_to_text(image, lang='eng+heb'):
    return pytesseract.image_to_string(image, lang=lang)
// Source: config.py
import os
from dotenv import load_dotenv

load_dotenv()
os.environ['OPENAI_API_KEY'] = os.getenv("OPENAI_API_KEY")
os.environ["TESSDATA_PREFIX"] = r"C:\Program Files\Tesseract-OCR\tessdata"
// Source: exam-analysis.py
import os
from dotenv import load_dotenv
from langdetect import detect
from flask import Flask, request, jsonify
from flask_cors import CORS
import pytesseract
from PIL import Image
from openai import OpenAI
import requests
import json


app = Flask(__name__)
CORS(app)

load_dotenv()
my_api_key = os.getenv("OPENAI_API_KEY")
os.environ['OPENAI_API_KEY'] = my_api_key

os.environ["TESSDATA_PREFIX"] = r"C:\Program Files\Tesseract-OCR\tessdata"
client = OpenAI()
my_model = "gpt-4o-mini"
def extract_name_from_text_using_list(student_text, student_list):
    names_str = "\n".join(student_list)
    prompt = f"""
    ×œ×”×œ×Ÿ ×¨×©×™××ª ×©××•×ª ×©×œ ×ª×œ××™×“×•×ª:
    {names_str}

    ×–×”×• ×˜×§×¡×˜ ×©× ×œ×§×— ×××‘×—×Ÿ ×©×œ ××—×ª ××”×Ÿ:
    {student_text}

    ×”×•×¨××•×ª ×—×©×•×‘×•×ª:
    - ×¢×œ×™×š ×œ×‘×—×•×¨ ××š ×•×¨×§ ×©× ××ª×•×š ×”×¨×©×™××” â€“ ××¡×•×¨ ×œ×”××¦×™× ×©××•×ª ×©×œ× ×§×™×™××™× ×‘×”.
    - ×’× ×× ××•×¤×™×¢ ×‘×˜×§×¡×˜ ×©× ×“×•××” ××š ×©×’×•×™ ×‘×›×ª×™×‘, ×¢×œ×™×š ×œ×”×ª××™× ××•×ª×• ×œ×©× ×”×›×™ ×“×•××” ××”×¨×©×™××” **×•×œ×”×—×–×™×¨ ××ª ×”× ×™×¡×•×— ×”××“×•×™×§ ×©××•×¤×™×¢ ×‘×¨×©×™××”**.
    - ×× ××™×Ÿ ×”×ª×××” ×¡×‘×™×¨×” â€“ ×”×—×–×¨ "Null".

    ğŸ“Œ ×”×¤×œ×˜ ×—×™×™×‘ ×œ×”×™×•×ª ×‘×§×•×‘×¥ JSON ×‘×œ×‘×“, ×œ×œ× ×”×¡×‘×¨×™×, ×•×œ×œ× ×˜×§×¡×˜ × ×•×¡×£, ×•×‘×¤×•×¨××˜ ×”×‘×:
    ×”×¤×œ×˜ ×—×™×™×‘ ×œ×”×ª×—×™×œ ×‘×¡×•×’×¨×™×™× ×”××¡×•×œ×¡×œ×•×ª ×©×œ ×” JSON
    {{
    "firstName": "×©× ×¤×¨×˜×™ ××ª×•×š ×”×¨×©×™××” ××• Null",
    "lastName": "×©× ××©×¤×—×” ××ª×•×š ×”×¨×©×™××” ××• Null",
    "confidence": "××—×•×–×™× ×-0 ×¢×“ 100"
    }}
    """

    response = client.chat.completions.create(
        model=my_model,
        messages=[
            {"role": "system", "content": "××ª×” ××–×”×” ×©××•×ª ×©×œ ×ª×œ××™×“×•×ª ××ª×•×š ×˜×§×¡×˜×™× ×©×œ ××‘×—× ×™×."},
            {"role": "user", "content": prompt}
        ]
    )
   
    try:
        result = json.loads(response.choices[0].message.content)
        firstName = result.get("firstName")
        lastName = result.get("lastName")
        confidence = int(result.get("confidence", 0))
        if firstName != "Null" and lastName != "Null":
            return firstName,lastName, confidence
    except Exception as e:
        print("AI name extract error:", e)

    return "Null", "Null", 0


def grade_exam(student_exam, teacher_exam):
    print(student_exam)
    print(teacher_exam)
    prompt = f"""
    ×ª×œ××™×“×” ×¢× ×ª×” ×¢×œ ×”××‘×—×Ÿ ×”×‘×:
    {student_exam}

    ×”×ª×©×•×‘×•×ª ×”× ×›×•× ×•×ª ×”×Ÿ:
    {teacher_exam}

    ×× × ×ª×Ÿ ×¦×™×•×Ÿ ××“×•×™×§ ×‘××—×•×–×™× ×œ×ª×©×•×‘×•×ª ×©×œ ×”×ª×œ××™×“×” ×•×”×¡×‘×¨ ××ª ×”×¦×™×•×Ÿ. ×× ×”×ª×©×•×‘×•×ª ×©×œ ×”×ª×œ××™×“×” × ×›×•× ×•×ª, ×’× ×× ×”×Ÿ ×©×•× ×•×ª ××”×ª×©×•×‘×•×ª ×©×œ ×”××•×¨×”, ×× × ×¦×™×™×Ÿ ×–××ª ×›"× ×›×•×Ÿ",  ×•×”×¡×‘×¨ ×©×”×Ÿ ×›×•×œ×œ×•×ª ××ª ×”××™×“×¢ ×”×‘×¡×™×¡×™ ×”× ×“×¨×©. 
    ×× ×”×ª×©×•×‘×•×ª × ×›×•× ×•×ª ××š ×—×¡×¨×•×ª ×¤×¨×˜×™× ×–× ×™×—×™× , ×™×© ×œ×¦×™×™×Ÿ ×–××ª, ××š ×œ× ×œ×”×•×¨×™×“ ×¦×™×•× ×™×  .
    ×× ×™×© ×‘×”×Ÿ ×—×œ×§ ×©×’×•×™ ×œ×—×œ×•×˜×™×Ÿ ××– ×™×© ×œ×”×•×¨×™×“ 
     ×”×—×–×¨ ××ª ×”×ª×©×•×‘×•×ª ×‘×¤×•×¨××˜ JSON ×›×š:
     ×œ×œ× ×”×•×¡×¤×ª ×”××™×œ×” JSON 
     ×”×ª×©×•×‘×” ×¦×¨×™×›×” ×œ×”×ª×—×™×œ ×™×©×¨ ×‘ 
    {{
        "grade": "×¦×™×•×Ÿ ×‘××—×•×–×™×",
        "evaluation": "×”×¢×¨×›×” ×‘××™×œ×™×"
    }}
    """
    
    response = client.chat.completions.create(
        model=my_model,
        messages=[
            {
                "role": "system",
                "content": "You are a helpful assistant."
            },
            {
                "role": "user",
                "content": prompt
            }
        ])
   
    
    return response.choices[0].message.content

   
@app.route('/extract-name', methods=['POST'])
def extract_name():
    
    uploaded_file = request.files.get('file')
  
    student_names_list = request.form.get('student_names_list')
    print("student_names_list: ", student_names_list)
    language = request.form.get('language', 'eng+heb') 

    if not uploaded_file or not student_names_list:
        return jsonify({"error": "Missing file or student_names_list"}), 400

    try:
        student_names_list = json.loads(student_names_list)  
        student_image = Image.open(uploaded_file)
        student_exam_text = pytesseract.image_to_string(student_image, lang=language)
      
        firstName, lastName, confidence = extract_name_from_text_using_list(student_exam_text, student_names_list)

        return jsonify({
            "firstName": firstName,
            "lastName": lastName,
            "confidence": confidence,
        })

    except Exception as e:
        print(e)
        return jsonify({"error": str(e)}), 500


@app.route('/detect-language', methods=['POST'])
def detect_language():
    try:
        if 'file' not in request.files:
            return jsonify({"error": "Missing file"}), 400

        file = request.files.get('file')
        image = Image.open(file)
       
        text = pytesseract.image_to_string(image, lang='eng+heb')

        if not text.strip():
            return jsonify({"language": "unknown"})

        lang_code = detect(text)

        if lang_code == 'he':
            language = 'heb'
        elif lang_code == 'en':
            language = 'eng'
        else:
            language = 'unknown'

        return jsonify({
            "language": language
        })

    except Exception as e:
        return jsonify({"language": "unknown", "error": str(e)}), 500


@app.route('/grade', methods=['POST'])
def grade():
    print(request.headers)
    if 'student_exam' not in request.files or 'teacher_exam' not in request.files:
        return jsonify({"error": "Missing student_exam or teacher_exam file"}), 400

    try:
        student_exam_file = request.files['student_exam']
        teacher_exam_file = request.files['teacher_exam']
        language = request.form.get('lang', 'eng+heb') 

        student_image = Image.open(student_exam_file.stream)
        teacher_image = Image.open(teacher_exam_file.stream)

        student_exam_text = pytesseract.image_to_string(student_image, lang=language)
        teacher_exam_text = pytesseract.image_to_string(teacher_image, lang=language)

        grade_result = grade_exam(student_exam_text, teacher_exam_text)
        result_json = json.loads(grade_result)
        grade = result_json.get("grade")
        evaluation = result_json.get("evaluation")
     
        return jsonify({
            "grade": grade,
            "evaluation": evaluation
        })

    except Exception as e:
        print(e)
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)
